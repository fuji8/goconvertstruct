# gotypeconverter

gotypeconverterは構造的に異なる二つの型を変換する関数を生成します。
関数名は、`Convert${src}To${dst}`です。与えられた型の要素を再帰的に解析して、一致する型で代入するようなコードを生成します。両者がnamed typeの場合、新たに関数を作成します。
複数の関数が生成される場合や、既に関数が存在する場合は、関数名でソートされます。
そのため、出力するファイルが同じであっても実行順序に左右されず、同一の結果が得られます。

## Install
```shell
go install github.com/fuji8/gotypeconverter/cmd/gotypeconverter
```

## Usage
```shell
> gotypeconverter                          
gotypeconverter: gotypeconverter generates a function that converts two different named types.

Usage: gotypeconverter [-flag] [package]


Flags:
  -d string
        destination type
  -o string
        output file; if nil, output stdout
  -pkg string
        output package; if nil, the directoryName and packageName must be same and will be used
  -s string
        source type
  -structTag string
         (default "cvt"))
```

## 注意
パッケージ名とディレクトリ名が一致しない場合は、`-pkg`で該当するパッケージ名を指定してください。

解析が失敗した時に、`tmp*.go`のようなファイルが残る可能性があります。
解析に使用される一時ファイルで、終了時に残ってしまった場合は消してください。

## Examples
see [testdata](https://github.com/fuji8/gotypeconverter/tree/main/testdata/src)
### Basic example
```go basic.go
package main

type basicSrc struct {
	foo int
	bar float64
	x   string
	y   string
}

type basicDst struct {
	foo int
	bar float32
	x   string
	z   string `cvt:"y"`
}
```

```shell
> gotypeconverter -s basicSrc -d basicDst -pkg main  .
// Code generated by gotypeconverter; DO NOT EDIT.
package main

func ConvertbasicSrcTobasicDst(src basicSrc) (dst basicDst) {
        dst.foo = src.foo
        dst.x = src.x
        dst.z = src.y
        return
}
```

フィールド名が同じもので代入します。該当する構造体タグがある場合は、フィールド名ではなく構造体タグを見ます。（[詳細はこちら](https://github.com/fuji8/gotypeconverter/blob/main/README_JA.md#structandstruct)）

### Normal example
```go normal.go
package normal

type e struct {
	e       bool
	m       string
	x       int
	members []uint8
}

type ug struct {
	uaiueo uint8
	gaaaa  uint8
}

type normalSrc struct {
	x struct {
		A int
		B bool
		C string
		D string
	}
	y int
	z float64
	m string

	members []ug
}

type normalDst struct {
	e
	x string
	y int
	z float64
}
```

```bash
> gotypeconverter -s normalSrc -d normalDst .                                
// Code generated by gotypeconverter; DO NOT EDIT.
package normal

func ConvertnormalSrcTonormalDst(src normalSrc) (dst normalDst) {
        dst.e.m = src.m
        dst.e.x = src.x.A
        dst.e.members = make([]uint8, len(src.members))
        for i := range src.members {
                dst.e.members[i] = src.members[i].uaiueo
        }
        dst.x = src.x.C
        dst.y = src.y
        dst.z = src.z
        return
}
```

構造体の埋め込みは、展開して解釈します。（`dst.e.m = src.m`）
`dst.e.x`と`dst.x`は、`int`と`struct`で型が異なりますが、`dst.x.A`が`int`のため、これと代入させます。
`dst.e.members[i]`は`uint8`で、`ug`は`uint8`のフィールドを2つ持っています。
この場合は、一番上に書いてあるフィールドで代入されます。
その他のフィールドに代入させたい場合は、上に書いてあるフィールドを構造体タグで`cvt:"-"`と指定してフィールドを無視させてください。（[詳細はこちら](https://github.com/fuji8/gotypeconverter/blob/main/README_JA.md#struct)）



## 変換規約
basic, named, struct, slice, pointer(wip)に対しては、特別な処理を行います。その他の型は今のところ、完全一致のみです。

https://github.com/fuji8/gotypeconverter/blob/v0.1.0/gotypeconverter.go#L449-L543

変換は、このswitch文によって行われます。

関数は、`XAndOther` `OtherAndX` `XAndX`の3タイプで構成されています。(X$\in$ {basic, named, struct, slice, pointer})`XAndOther`は、dstの型がXでsrcの型がその他の型であるときの処理です。`XAndOther` `OtherAndX`は、dstとsrcが逆なだけで意味的にはほぼ同一です。`XAndX`は、両者の型がXで同一であるときの処理です。

### Basic
特別な処理はない。

### Named
`underlying()`する。

キャストをしないので、コンパイルエラーなコードが生成され得る。
[#13](https://github.com/fuji8/gotypeconverter/issues/13)

#### `namedAndOther` `OtherAndNamed` 
`underlying()`して再帰。

#### `namedAndNamed`
関数を作成してそれを呼び出します。
関数の中身が空であっても、その関数を呼び出します。

### Struct
フィールドを見る。

また、次の構造体タグは特別な意味を持ちます。
|種類|意味|
| - | - |
| `-` | 無視 |
| `->` | 読み込み限定（`src`としてのみ意味を持つ）|
| `<-` | 書き込み限定（`dst`としてのみ意味を持つ）|

複数のタグを指定する時は、`, `で区切ってください。

埋め込みは、展開して解釈する。

```go
type e struct {
	e       bool
	m       string
	x       int
	members []uint8
}

type normalDst struct {
	e
}
```
これは以下と同じと解釈します。
```go
type normalDst struct {
	e       bool
	m       string
	x       int
	members []uint8
}
```


#### `structAndOther` `OtherAndStruct` 

その他がstructのフィールドに含まれるとして再帰します。あるフィールドで書き込めた時点で、それ以上再帰を呼び出すのをやめます。

```go
type x string

type bar struct {
    y string
    z string
}
```

これに対しては、以下のように最初に来るものに対して代入を成立させて、後のを無視します。

```shell
> gotypeconverter -s x -d bar -pkg foo .
// Code generated by gotypeconverter; DO NOT EDIT.
package foo

func ConvertxTobar(src x) (dst bar) {
        dst.y = src
        return
}
```

#### `structAndStruct`
両者のフィールドを一つずつ見ていき、フィールド名が一致したとき再帰します。
フィールド名の代わりを構造体タグで指定出来ます。標準は`cvt`ですが、フラグ`-structTag`で自由に変更できます。

### Slice
`Elem()`を見る。

#### `sliceAndOther` `otherAndSlice`
1番目の要素を見る。

#### `sliceAndSlice`
srcの分だけforでループ。

### Pointer (WIP)
selectorを`(*%s)`して、`Elem()`を見る。